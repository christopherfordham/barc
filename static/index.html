
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="/manifest.json" />
  <title>BARC — BA Roster Check</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e6eaf2}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#10192d;border:1px solid #20304d;border-radius:10px;padding:16px;margin:16px 0}
    input,select,button,textarea{padding:10px;border-radius:8px;border:1px solid #2a3a5d;background:#0d1730;color:#e6eaf2}
    button{cursor:pointer}
    label{display:block;margin:8px 0 4px;color:#9fb4d9}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .badge{display:inline-block;background:#1a2b4f;padding:4px 10px;border-radius:999px;color:#9fc5ff;margin-left:8px}
    pre{background:#0b152a;border:1px solid #1b2b45;padding:12px;border-radius:8px;overflow:auto;max-height:260px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #213253;padding:8px;text-align:left}
    .good{color:#79e0a8} .warn{color:#ffd37f} .bad{color:#ff9393}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BARC <span class="badge">BA Roster Check</span></h1>
    <p>Upload your <strong>eMaestro XML roster</strong> to check the entire month (planned and—later—operated). Or test a single duty below.</p>

    <div class="card">
      <h2>API endpoint</h2>
      <p>Use this page's URL on Render: e.g. <code>https://barc.onrender.com</code></p>
      <input id="api" placeholder="https://barc.onrender.com" style="width:100%"/>
    </div>

    <div class="card">
      <h2>Upload eMaestro XML</h2>
      <input type="file" id="file" accept=".xml"/>
      <button id="upload">Upload + Check</button>
      <div id="summary"></div>
      <pre id="rosterOut"></pre>
    </div>

    <div class="card">
      <h2>Check a single duty</h2>
      <div class="grid">
        <div>
          <label>Status</label>
          <select id="status">
            <option value="planned">planned (forecast)</option>
            <option value="operated">operated (actual)</option>
          </select>
        </div>
        <div>
          <label>Base timezone</label>
          <input id="tz" value="Europe/London" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Planned start (UTC)</label>
          <input id="pstart" placeholder="2025-10-20T17:15:00Z"/>
        </div>
        <div>
          <label>Planned end (UTC) — or block mins</label>
          <input id="pend" placeholder="optional e.g. 2025-10-20T21:30:00Z"/>
          <input id="pblk" placeholder="or block minutes e.g. 255" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Actual start (UTC)</label>
          <input id="astart" placeholder="for operated only e.g. 2025-10-20T17:27:00Z"/>
        </div>
        <div>
          <label>Actual end (UTC)</label>
          <input id="aend" placeholder="for operated only e.g. 2025-10-20T23:32:00Z"/>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Disruption reason</label>
          <select id="reason">
            <option value="">(none)</option>
            <option value="delay">delay</option>
            <option value="diversion">diversion</option>
            <option value="disruption">disruption</option>
          </select>
        </div>
        <div>
          <label>Next planned duty start (UTC) — optional</label>
          <input id="nextstart" placeholder="e.g. 2025-10-21T06:00:00Z"/>
        </div>
      </div>

      <p><button id="chk">Check duty</button></p>
      <pre id="out"></pre>
    </div>

    <div class="card">
      <h2>Install on your phone</h2>
      <ol>
        <li>Open this page on your phone.</li>
        <li>iOS Safari: Share → Add to Home Screen. Android Chrome: ⋮ → Add to Home Screen.</li>
        <li>It will install as “BARC”.</li>
      </ol>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const api = () => ($("#api").value.trim() || location.origin).replace(/\/$/, '');

    $("#upload").addEventListener("click", async () => {
      const f = $("#file").files[0];
      if(!f){ alert("Choose an XML file first."); return; }
      const fd = new FormData();
      fd.append("file", f);
      const res = await fetch(api()+"/upload-roster", { method:"POST", body: fd });
      const json = await res.json();
      const meta = json.meta || {};
      $("#summary").innerHTML = `<p><strong>Parsed duties:</strong> ${json.parsed_duties || 0} &nbsp; | &nbsp; <strong>Crew:</strong> ${meta.crew_id || 'n/a'} &nbsp; | &nbsp; <strong>Period:</strong> ${(meta.period_start||'?')} → ${(meta.period_end||'?')}</p>`;
      $("#rosterOut").textContent = JSON.stringify(json, null, 2);
    });

    $("#chk").addEventListener("click", async () => {
      const payload = {
        duty_id: "UI-TEST-1",
        crew_id: "UI-USER",
        status: $("#status").value,
        base_timezone: $("#tz").value || "Europe/London",
        planned_start_utc: $("#pstart").value,
        planned_end_utc: $("#pend").value || null,
        planned_block_minutes: $("#pblk").value ? parseInt($("#pblk").value,10) : null,
        actual_start_utc: $("#astart").value || null,
        actual_end_utc: $("#aend").value || null,
        disruption_reason: $("#reason").value || null,
        next_planned_duties: $("#nextstart").value ? [{start_utc: $("#nextstart").value}] : []
      };
      const res = await fetch(api()+"/check-duty", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      $("#out").textContent = JSON.stringify(json, null, 2);
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
